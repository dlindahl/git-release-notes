#!/bin/sh
# Inspired by: https://github.com/visionmedia/git-extras/blob/a55cc84a1145936535e00153ac4cdd6a1f6812cc/bin/git-changelog

while [ "$1" != "" ]; do
  case $1 in
    -l | --list )
      LIST=true
      ;;
    -t | --tag )
      TAG=$2
      shift
      ;;
    * )
      FILE=$1
      ;;
  esac
  shift
done

function format_changes {
  changes=$(eval "$CMD | sed 's/(@\([^@]*\).*)/(@\1)/'")
  if test -z "$changes"; then
    echo "There have been no changes since $version was tagged."
    echo ""
    echo "Did you mean to display the notes for the previous tag?"
    exit 1
  else
    echo $HEADER
    echo ""
    echo "$changes"
  fi
}

if $LIST; then
  version=$(git describe --tags --abbrev=0)

  BASE_CMD="git --no-pager log --format='* %s (@%ae) %h'"
  if test -z "$version"; then
    HEADER="Release notes for the entire repo"
    CMD=$BASE_CMD
  else
    HEADER="Release notes for $version"
    CMD="$BASE_CMD $version.."
  fi
  format_changes
fi

